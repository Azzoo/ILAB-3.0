<!DOCTYPE html>
<head>

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <script type="text/javascript" src="http://services.web-manufacture.net/Base/v1.5?join=true"></script>
    <link href="http://services.web-manufacture.net/Styles/System.default.css" rel="stylesheet">
    <title>Server Files</title>

    <script src="http://services.web-manufacture.net/ilab-socket.js" type="text/javascript"></script>
    <script src="../Client/WebSocketProxy.js" type="text/javascript"></script>

    <script type="text/javascript" src="files-widget.js"></script>

    <script type="text/javascript">

        WS.DOMload(function(){
            Channels.on('created-dir', function(path){
                FS.ReloadSystem();
                folderCreator.add(".invisible");
                DirInput.value = '';
            });

            WS.Body.ondragover = function(event) {
                var types = event.dataTransfer.types;
                if (types[2] && types[2] == "Files"){ event.preventDefault(); return true; }
                return false;
            };

            function upload(file){
                Notify.Show("Uploading " + file.name + "");
                var xhr = new XMLHttpRequest();
                xhr.open('POST',  window.location + "/" + file.name, true);
                xhr.onload = function(e) {
                    Notify.Show("file " + file.name + " uploaded!");
                    FS.ReloadSystem();
                };
                xhr.send(file);
            }

            WS.Body.ondrop = function(event) {
                var types = event.dataTransfer.types;
                var files = event.dataTransfer.files;
                if (types && types.length && (types[0] == "Files" || types[0]== "application/x-moz-file") && files && files.length > 0){
                    event.preventDefault();
                    for (var i = 0; i < files.length; i++){
                        upload(files[i]);
                    }
                    return true;
                }
                return false;
            };

            DirInput.add("!blur", function() {
                folderCreator.add(".invisible");
                DirInput.value = '';
            });

        })

        Dialog = {};

        Dialog.Apply = function(elem){
            var dialog = elem.findParent(".dialog");
            dialog.hide();
            var value = dialog.get(".dialog-value");
            if (Check(dialog.onapply)){
                dialog.onapply(value.value);
            }
        };

        Dialog.Close = function(elem){
            var dialog = elem.findParent(".dialog");
            dialog.hide();
        };

        InputEnter = function(event){
            if(event.keyCode == 10){
                folderCreator.hide();
                DirInput.value = '';
            }
            if(event.keyCode == 13){
                FS.CreateNewDir();
                folderCreator.hide();
                DirInput.value = '';
                /*FS.server.CreateDir(DirInput.value).then(function(){
                   Channels.emit('dir-created');
                }).catch(function(error){
                    console.error(error)
                });*/
            }
        }

        FolderInputRender = function(){
            folderCreator.del(".invisible");

        };




    </script>

    <link href="files-widget.css" rel="stylesheet">

    <style type="text/css">

    </style>
</head>
<body>

<!--include url='http://services.web-manufacture.net/SysUtils/Log.htm'></include-->
<include url='http://services.web-manufacture.net/UI/toolbars.htm'></include>
<include url='http://services.web-manufacture.net/UI/Notification.htm'></include>
<include url='http://services.web-manufacture.net/UI/HtmlElements.htm'></include>
<!--include url='http://services.web-manufacture.net/Authentication/Authentication.htm'></include-->
<div class='toolbar vertical fixed with-titles' id='HeaderBar'>
    <div class='menuitem file-manager-button' id='create-file-button' icon="http://system.web-manufacture.net/images/document-small.png" onclick="FS.CreateNewDoc()">
        Создать
    </div>
    <div class='menuitem file-manager-button' id='create-folder-button' icon="http://system.web-manufacture.net/images/folderopened_yellow.png" onclick="FolderInputRender()">
        Создать папку
    </div>
    <div class='menuitem file-manager-button' id='delete-file' icon="http://system.web-manufacture.net/images/delete-mini.png" onclick="FS.DeleteDocs()">
        Удалить
    </div>
    <div class="menuitem round" icon="http://system.web-manufacture.net/images/ButtonUSSR.png" onclick="FS.ClearTagFilter();">
        Отменить фильтрацию
    </div>
    <div class="menuitem round" icon="" onclick="FS.ClearSelect();">
        Убрать выделение
    </div>

</div>

<div id="Help" class=''>
    <div class="event info">
        <div class="event info">Вы можете перетащить сюда файлы для загрузки в данную папку.</div>
        <br>
        <div class="event info">Для того чтобы добавить файл или папку, введите его имя в поле в верхнем левом углу и нажмите "Создать"</div>
        <br>
        <div class="event info">Чтобы открыть файл, дважды кликните по нему</div>
        <br>
        <div class="event info">Чтобы править файл, кликните по нему с нажатой кнопкой Ctrl</div>
        <br>
        <div class="event info">Скомпилировать проект, можно кнопочкой "Собрать", вверху</div>
        .</div>
</div>
<div id="files-block" class="files-block" title="File System">
    <div id='FilterBlock'>
        <div class='title'>Фильтр и поиск:</div>
        <input id="FilterInput" type='text'/>
        <div class="btn-ira round" onclick="FS.ClearTagFilter();">
            очистить фильтр
        </div>
    </div>
    <div id="folderCreator" class="invisible dir">
        <input onkeydown="InputEnter(event)" id="DirInput" type="text" default-text="Название папки"></input>
    </div>
    <div id='LoadingMask'>
        <div class='loading-text'>Loading...</div>
    </div>
    <div class="tree-container">


    </div>
    <div class="edit-name-dialog dialog">
        <div class="dialog-inner" id="NewDocDialogInner">
            <input id="txtFileName" class="file-name dialog-value" value="" type="text"><br>
            <div id="btnApply" class="button dialog-apply" onclick="Dialog.Apply(this)">
                Принять</div>
            <div id="btnCancel" class="button dialog-close" onclick="Dialog.Close(this)">
                Отменить</div>
        </div>
    </div>
    <div id="LoadDocDialog" class="dialog">
        <div class="dialog-inner">
            <input id="fileUploader" multiple="multiple" type="file">
            <button type="button" id="btnApply" class="dialog-apply">
                Принять</button>
            <button type="button" id="btnCancel" class="dialog-close">
                Отменить</button>
        </div>
    </div>

</div>

</body>