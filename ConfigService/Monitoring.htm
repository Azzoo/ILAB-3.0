<!DOCTYPE HTML>

<html>
	<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <link type='text/css' rel='stylesheet' href="http://Services.web-manufacture.net/Styles/System.default.css"/>
    <script type="text/javascript" src="http://services.web-manufacture.net/Base/v1.5?join=true"></script>
    <script type="text/javascript" src="http://services.web-manufacture.net/ilab-socket.js"></script>

    <title>Конфигурация сервера</title>
    
    <link type='text/css' rel='stylesheet' href="main.css"/>
		
		<script>
			M.ServicesUrl = "http://services.web-manufacture.net";
			M.ModulesUrl = "http://modules.web-manufacture.net";
			M.SystemUrl = "http://system.web-mnanufacture.net";
			
			Notify = {};
			
			Notify.Show = function (message) {
				var nf = DOM("#Notify");
				var ev = nf.div(".event.first", (new Date()).formatTime() + " " + message);
				nf.show();
				nf.ins(ev);
				Notify.setTimeout();
			};
			
			Notify.ShowMessage = function (message) {
				var nf = DOM("#Notify");
				var ev = nf.div(".event.first", (new Date()).formatTime() + " " + JSON.stringify(message));
				nf.show();
				nf.ins(ev);
				Notify.setTimeout();
			};
			
			Notify.Error = function (error) {
				var nf = DOM("#Notify");
				var ev = nf.div(".event.error.first", (new Date()).formatTime() + " " + error);
				nf.show();
				nf.ins(ev);
				Notify.setTimeout();
			};
			
			Notify.setTimeout = function () {
				if (Notify.timeout) {
					window.clearTimeout(Notify.timeout);
				}
				Notify.timeout = window.setTimeout(Notify.clearFirst, 3000);
			};
			
			Notify.clearFirst = function () {
				DOM.all("#Notify .event.first").del(".first");
			};
			
			Monitor = {}; 
			
			Monitor.Init = function(){
				Monitor.startDate = new Date();
				Monitor.lastLogDate == null;
				//Monitor.startDate = Monitor.startDate.getTime();
				//Monitor.Url = (this.location + "").replace(this.location.search, "").toLowerCase();
				//Monitor.Url = Monitor.Url.replace("/monitoring.htm", "");
				Monitor.serviceId = Request.Params.service;
				document.title = Monitor.serviceId;
				DOM("#urlBar").set(Monitor.serviceId);
				
				Server = {};

				Server.Start = function(item){
				    if (Monitor.servicesManager){
				        Monitor.servicesManager.StartService(Monitor.serviceId);
				    }
				}
				Server.Stop = function(item){
					if (Monitor.servicesManager){
				        Monitor.servicesManager.StopService(Monitor.serviceId);
				    }
				}
				Server.Reset = function(item){
					if (Monitor.servicesManager){
				        Monitor.servicesManager.ResetService(Monitor.serviceId);
				    }
				} 

                ServiceProxy.Init("ws://localhost:5700").then((servicesManager) => {
                    Monitor.servicesManager = servicesManager;
                    servicesManager.on("service-started", (params) => {
                        Monitor.ServerStatus(params);
                    });
                    servicesManager.on("service-loaded", (params) => {
                        Monitor.ServerStatus(params);
                        Monitor.ConnectService();
                    });
                    servicesManager.on("service-connected", (params) => {
                        Monitor.ServerStatus(params);
                    });
                    servicesManager.on("service-exited", (params) => {
                        Monitor.ServerStatus(params);
                    });
                    servicesManager.on("service-error", (params) => {
                        Monitor.ServerStatus(params);
                    });
                })
				
				Monitor.ConnectService();
			};
			
			Monitor.ConnectService = function(){
			    ServiceProxy.Connect("ws://localhost:5700/" + Monitor.serviceId).then((service) => {
                    if (service){
                        service.emit = function(name, msg){
                            Monitor.LogMessage(name, msg);				
                            return this.__proto__.emit.apply(this, arguments);
                        };
                        service.on("closing-server", () => {
                           service.close(); 
                        });
                    }
                });
			}
						
			
			Monitor.ServerStatus = function (status) {
				WS.Body.del(".loading");
				if (Monitor.Status != status){
					Monitor.Status = status;
					Notify.Show(status);
					WS.Body.set("@status", status);
				}
			}; 		
						
			Monitor.LogMessage = function(type, msg){
				var logDiv = DOM.get('#logsMonitor');
				if (!type) type = "log";
				var proto = logDiv.get(".prototype." + type);
				if (!proto){
					proto = logDiv.get(".prototype.log");	
				}
				proto = proto.clone();
				var datetime = new Date();
				proto.get(".datetime").set(datetime.formatTime(true));
				if (type == "error"){
					proto.get(".text").set(msg);	
					proto.add(Monitor.ParseStack(msg));	
				}
				else{
					var content = '';
					var color = '';
					var text = msg;
					var mode = 0;
					if (text){
						for (var i = 0; i < text.length; i++){
							if (mode == 0){
								if (text[i] == ">"){
									content += "</span>";
								}
								if (text[i] == "<"){
									mode = 1;
									color = '';
									continue;
								}
								content += text[i];
								continue;
							}
							if (mode == 1){
								if (text[i] == ">" || text[i] == ":"){
									content += "<span class='user-color' style='color:" + color + "'>";
									mode = 0;
									continue;
								}
								color += text[i];
								continue;
							}
						}
					}
					proto.get(".text").set(content);	
				}
				logDiv.ins(proto);
				setTimeout(function(){
					proto.add(".old");	
				}, 60000 * 3)
			};
			
			Monitor.ParseStack = function(error){
				try{
					var errorDiv = DOM.div(".stack");
					var stack = error.stack.split('\n');
					for (var i = 0; i < stack.length; i++){
						var line = stack[i];
						line = line.replace(/</g, "&lt;").replace(/>/g, "&gt;");
						line = line.replace(/\s?at\s/, "");
						var sl = errorDiv.div(".stack-line");
						var iofaddr = line.indexOf("(");
						if (iofaddr >= 0){
							line = line.replace(/\((\w):\\/, "($1\\");
							var mod = /\(([^:]+):(\d+):(\d+)\)/.exec(line);
							line = line.substr(0, iofaddr);
							//sl.div(".module-name.stack-part.stack-part-prefix", mod[1] + " : " + mod[2] + "(" + mod[3] + ")");
							//sl.div(".row.stack-part.stack-part-prefix", mod[2] + "(" + mod[3] + ")");
							//sl.div(".col.stack-part.stack-part-prefix", mod[3]);
							sl.div(".function.stack-part", line);
							if (mod){
								sl.div(".module-name.stack-part", mod[1]);
								sl.div(".line.stack-part", " : " + mod[2]);
								sl.div(".column.stack-part", "(" + mod[3] + ")");							
							}
						}
						else{
							sl.set(null, line);	
						}
					}
				}
				catch (ex){
					return "Error parsing object: " + error;
				}
				return errorDiv;
			};
			
			
			
			WS.DOMload(Monitor.Init);	
			
		</script>
		
		
		<style>
			
			body{
				padding-top: 100px;	
			}
			
			body.loading .header.toolbar .menuitem.server-control {
				display: none;	
			}
			
			#logsMonitor {
				display: block;
				font-size: 12px;
				padding: 2px;
				text-align: left;
				font-family: monospace;
				width:80%;
			}
			
			#logsMonitor .log-item{
				display: inline-block;
				padding-left: 10px;	
				width: 100%;
			}
			
			#logsMonitor .log-item.old:first-child{
				margin-top: 10px;
			}
			
			#logsMonitor .log-item.old{
				opacity: 0.5;
			}
			
			#logsMonitor .log-item.old:hover{
				opacity: 1;	
			}
			
			#logsMonitor .log-item.error .datetime{
				color: red;
			}
			
			.stack-line{
				float: none;	
				clear:both;
			}
			
			.stack-line .stack-part{
				display: inline-block;
				padding-left: 5px;
			}
			
			.stack-line .stack-part.function{
				color: green;
			}
			
			.stack-line .stack-part.module-name{
				color: gray;
			}
			
			.stack-line .stack-part.line{
				color: navy;
				font-weight: bold;
			}
			
			#Notify{
				background-color: white;
				border: 1px solid navy;
				border-radius: 10px 10px 10px 10px;
				cursor: default;
				font-size: 16px;
				text-align: left;
				opacity: 0.5;
				position: absolute;
				top: 10%;
				right: 1%;
				z-index: 20;
				padding: 7px;
				font-size: 12px;
				overflow: hidden;
				width: 10%;
				height: 60%;
			}
			
			#Notify .event{
				color: #333;
			}
			
			#Notify .event.first{
				background-color:yellow;
			}
			
			#Notify .event.error{
				color: red;
			}
			
			body[status='working'] #Notify {
				background-color: #99FF99;
			}
			
			body[status='exited'] #Notify,
			body[status='idle'] #Notify{
				background-color: #FFFF99;
			}
			
			body[status='error'] #Notify {
				background-color: #FF3366;
			}
			
			.header.toolbar .menuitem.server-control:active{
				border:  1px solid black;
			}
			
			.header.toolbar #urlBar {
				border: 1px solid silver;
				border-radius: 5px;
				display: inline-block;
				width: 500px;
			}
			
			
		</style>
		
	</head>
	<body>
		
		<include url='http://services.web-manufacture.net/UI/toolbars.htm'></include>
		<div class='header toolbar'>			
			<div class='menuitem server-control' id='serverStart' onclick="Server.Start();">
				СТАРТ
			</div>
			<div class='menuitem server-control' id='serverStop' onclick="Server.Stop();">
				СТОП
			</div>
			<div class='menuitem server-control' id='serverRestart' onclick="Server.Reset();">
				РЕСТАРТ
			</div>
			
			<div class="menuitem server-control url-go invisible" onclick="Monitor.GoUrl(DOM('#urlBar').innerHTML);">GO!</div>
			<div id="urlBar" class="invisible" contenteditable="true" ></div>
		</div>
		<div  id='Notify'>
		</div>
		<div  id='logsMonitor'>
			<div class='log-item info prototype'>
				<span class='datetime'></span>
				<span class='path'></span>
				<span class='text'></span>
			</div>
			<div class='log-item debug prototype'>
				<span class='datetime'></span>
				<span class='path'></span>
				<span class='text'></span>
			</div>
			<div class='log-item warn prototype'>
				<span class='datetime'></span>
				<span class='path'></span>
				<span class='text'></span>
			</div>
			<div class='log-item error prototype'>
				<span class='datetime'></span>
				<span class='path'></span>
				<span class='text'></span>
			</div>
			<div class='log-item log prototype'>
				<span class='datetime'></span>
				<span class='path'></span>
				<span class='text'></span>
			</div>
		</div>
	</body>
	
</html>	  